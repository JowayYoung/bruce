var x=this&&this.__awaiter||function(i,e,t,o){return new(t||(t=Promise))((function(n,r){function m(i){try{a(o.next(i))}catch(i){r(i)}}function s(i){try{a(o.throw(i))}catch(i){r(i)}}function a(i){var e;i.done?n(i.value):(e=i.value,e instanceof t?e:new t((function(i){i(e)}))).then(m,s)}a((o=o.apply(i,e||[])).next())}))};import{readFileSync as tt,writeFileSync as st}from"fs";import{basename as _,join as ii}from"path";import{exit as o}from"process";import{AbsPath as S,CreateDir as rs,RemoveDir as eo,RoundNum as ei,WaitFor as _e}from"@yangzw/bruce-us/dist/node.js";import ti from"imagemin";import oi from"imagemin-gifsicle";import ni from"imagemin-jpegtran";import ri from"imagemin-pngquant";import mi from"imagemin-svgo";import si from"imagemin-webp";import ze from"is-animated";import no from"ora";import{COMPRESS_TEXT as Se}from"../langs/index.js";import{OUTPUT_DIR as ai,FilterImg as pi,FormatExt as ci,GetExt as ui,ShowTitle as io}from"../utils/index.js";const li={gif:oi({interlaced:!1,optimizationLevel:3}),jpg:ni({arithmetic:!1,progressive:!0}),png:ri({quality:[.6,.8],speed:1}),svg:mi({plugins:[{active:!1,name:"removeViewBox"},{active:!1,name:"cleanupIDs"},{active:!0,name:"removeDimensions"}]}),webp:si({alphaQuality:100,quality:80})};function fi(i=""){return x(this,void 0,void 0,(function*(){const e=tt(i),t=ui(i);if(ze(e)&&"webp"===t)return Se.result2(i,"webp动态图像无法压缩");try{const o=ii(ai.compress,i.replace(_(i),"")),n=S(ii(ai.compress,ci(i))),r=yield ti.buffer(e,{plugins:[li[t]]}),m=ei({num:e.length}),s=ei({num:r.length}),a=ei({num:1-s/m,per:!0});return rs(o),st(n,r),Se.result1(i,{inputSize:m,outputSize:s,ratio:a})}catch(e){return Se.result2(i,e.message)}}))}export default function vo(){return x(this,void 0,void 0,(function*(){io("compress");const i=no(Se.doing).start();eo(ai.compress),rs(ai.compress);const{count:e,imgs:t}=pi(),n=t.map((i=>x(this,void 0,void 0,(function*(){return yield fi(i)})))),r=yield Promise.all(n);yield _e(2e3),i.stop(),console.log(Se.stats(e)),r.length<=100&&r.forEach((i=>console.log(i))),console.log(Se.done),o(1)}))}