var x=this&&this.__awaiter||function(e,o,i,t){return new(i||(i=Promise))((function(n,r){function m(e){try{a(t.next(e))}catch(e){r(e)}}function s(e){try{a(t.throw(e))}catch(e){r(e)}}function a(e){var o;e.done?n(e.value):(o=e.value,o instanceof i?o:new i((function(e){e(o)}))).then(m,s)}a((t=t.apply(e,o||[])).next())}))};import{readFileSync as ue,writeFileSync as fe}from"node:fs";import{basename as _,join as qo}from"node:path";import{exit as s}from"node:process";import{AbsPath as S,CreateDir as ns,RemoveDir as eo,RoundNum as Do,WaitFor as to}from"@yangzw/bruce-us/dist/node.js";import Po from"imagemin";import So from"imagemin-gifsicle";import _o from"imagemin-jpegtran";import Lo from"imagemin-pngquant";import Qo from"imagemin-svgo";import Vo from"imagemin-webp";import ko from"is-animated";import no from"ora";import{COMPRESS_TEXT as e$}from"../langs/index.js";import{OUTPUT_DIR as Ao,FilterImg as Ho,FormatExt as Jo,GetExt as Ko,ShowTitle as io}from"../utils/index.js";const Mo={gif:So({interlaced:!1,optimizationLevel:3}),jpg:_o({arithmetic:!1,progressive:!0}),png:Lo({quality:[.6,.8],speed:1}),svg:Qo({plugins:[{active:!1,name:"removeViewBox"},{active:!1,name:"cleanupIDs"},{active:!0,name:"removeDimensions"}]}),webp:Vo({alphaQuality:100,quality:80})};function Oo(){return x(this,arguments,void 0,(function*(e=""){const o=ue(e),i=Ko(e);if(ko(o)&&"webp"===i)return e$.result2(e,"webp动态图像无法压缩");try{const t=qo(Ao.compress,e.replace(_(e),"")),n=S(qo(Ao.compress,Jo(e))),r=yield Po.buffer(o,{plugins:[Mo[i]]}),m=Do({num:o.length}),s=Do({num:r.length}),a=Do({num:1-s/m,per:!0});return ns(t),fe(n,r),e$.result1(e,{inputSize:m,outputSize:s,ratio:a})}catch(o){return e$.result2(e,o.message)}}))}export default function Fo(){return x(this,void 0,void 0,(function*(){io("compress");const e=no(e$.doing).start();eo(Ao.compress),ns(Ao.compress);const{count:o,imgs:i}=Ho(),t=i.map((e=>x(this,void 0,void 0,(function*(){return yield Oo(e)})))),n=yield Promise.all(t);yield to(2e3),e.stop(),console.log(e$.stats(o)),n.length<=100&&n.forEach((e=>console.log(e))),console.log(e$.done),s(1)}))}