var g=this&&this.__awaiter||function(t,o,e,r){return new(e||(e=Promise))((function(n,i){function s(t){try{l(r.next(t))}catch(t){i(t)}}function a(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){var o;t.done?n(t.value):(o=t.value,o instanceof e?o:new e((function(t){t(o)}))).then(s,a)}l((r=r.apply(t,o||[])).next())}))};import{readFileSync as ae}from"fs";import{basename as w,join as Ze}from"path";import{exit as o}from"process";import{AbsPath as $,CreateDir as ns,RemoveDir as ze,WaitFor as Fe}from"@yangzw/bruce-us/dist/node.js";import qe from"is-animated";import Je from"ora";import Gt from"sharp";import Rt from"text-to-svg";import{MarkAnswer as cn}from"../helpers/index.js";import{MARK_TEXT as Ke}from"../langs/index.js";import{OUTPUT_DIR as ai,FilterImg as mi,FormatExt as ci,GetExt as pi,ShowTitle as De}from"../utils/index.js";function It(t="",o){return g(this,void 0,void 0,(function*(){const e=ae($(t)),r=pi(t);if(qe(e)&&"webp"===r)return Ke.result2(t,"webp动态图像无法标记");try{const{blend:e,color:r,label:n,left:i="",position:s,size:a,top:l=""}=o,m=Ze(ai.mark,t.replace(w(t),"")),c=$(Ze(ai.mark,ci(t))),f=Object.assign({blend:e,input:Mt(n,+a,r)},"none"===s?{left:+i,top:+l}:{gravity:s});return ns(m),yield Gt(t).composite([f]).toFile(c),Ke.result1(t,n)}catch(o){return Ke.result2(t,o.message)}}))}function Mt(t="",o=12,e=""){const r=Rt.loadSync().getSVG(t,{anchor:"top",attributes:{fill:e},fontSize:o>=12?o:12});return Buffer.from(r)}export default function po(){return g(this,void 0,void 0,(function*(){De("mark");const t=yield cn(),e=Je(Ke.doing).start();ze(ai.mark),ns(ai.mark);const{count:r,imgs:n}=mi("jpg,png,webp,JPG,PNG,WEBP"),i=n.map((o=>g(this,void 0,void 0,(function*(){return yield It(o,t)})))),s=yield Promise.all(i);yield Fe(2e3),e.stop(),console.log(Ke.stats(r)),s.length<=100&&s.forEach((t=>console.log(t))),console.log(Ke.done),o(1)}))}