var x=this&&this.__awaiter||function(t,o,n,e){return new(n||(n=Promise))((function(r,i){function s(t){try{c(e.next(t))}catch(t){i(t)}}function a(t){try{c(e.throw(t))}catch(t){i(t)}}function c(t){var o;t.done?r(t.value):(o=t.value,o instanceof n?o:new n((function(t){t(o)}))).then(s,a)}c((e=e.apply(t,o||[])).next())}))};import{readFileSync as tt}from"node:fs";import{basename as _,join as qo}from"node:path";import{exit as s}from"node:process";import{AbsPath as S,CreateDir as ns,RemoveDir as eo,WaitFor as We}from"@yangzw/bruce-us/dist/node.js";import Xe from"is-animated";import no from"ora";import Gt from"sharp";import St from"text-to-svg";import{MarkAnswer as ar}from"../helpers/index.js";import{MARK_TEXT as kt}from"../langs/index.js";import{OUTPUT_DIR as Qo,FilterImg as Vo,FormatExt as Ao,GetExt as Go,ShowTitle as io}from"../utils/index.js";function Bt(){return x(this,arguments,void 0,(function*(t="",o){const n=tt(S(t)),e=Go(t);if(Xe(n)&&"webp"===e)return kt.result2(t,"webp动态图像无法标记");try{const{blend:n,color:e,label:r,left:i="",position:s,size:a,top:c=""}=o,l=qo(Qo.mark,t.replace(_(t),"")),f=S(qo(Qo.mark,Ao(t))),m=Object.assign({blend:n,input:Ft(r,+a,e)},"none"===s?{left:+i,top:+c}:{gravity:s});return ns(l),yield Gt(t).composite([m]).toFile(f),kt.result1(t,r)}catch(o){return kt.result2(t,o.message)}}))}function Ft(t="",o=12,n=""){const e=St.loadSync().getSVG(t,{anchor:"top",attributes:{fill:n},fontSize:o>=12?o:12});return Buffer.from(e)}export default function ko(){return x(this,void 0,void 0,(function*(){io("mark");const t=yield ar(),o=no(kt.doing).start();eo(Qo.mark),ns(Qo.mark);const{count:n,imgs:e}=Vo("jpg,png,webp,JPG,PNG,WEBP"),r=e.map((o=>x(this,void 0,void 0,(function*(){return yield Bt(o,t)})))),i=yield Promise.all(r);yield We(2e3),o.stop(),console.log(kt.stats(n)),i.length<=100&&i.forEach((t=>console.log(t))),console.log(kt.done),s(1)}))}