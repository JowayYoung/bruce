var x=this&&this.__awaiter||function(t,o,n,e){return new(n||(n=Promise))((function(r,i){function s(t){try{c(e.next(t))}catch(t){i(t)}}function a(t){try{c(e.throw(t))}catch(t){i(t)}}function c(t){var o;t.done?r(t.value):(o=t.value,o instanceof n?o:new n((function(t){t(o)}))).then(s,a)}c((e=e.apply(t,o||[])).next())}))};import{readFileSync as ue}from"node:fs";import{basename as _,join as qo}from"node:path";import{exit as s}from"node:process";import{AbsPath as S,CreateDir as ns,RemoveDir as eo,WaitFor as to}from"@yangzw/bruce-us/dist/node.js";import ko from"is-animated";import no from"ora";import kt from"sharp";import Pt from"text-to-svg";import{MarkAnswer as ar}from"../helpers/index.js";import{MARK_TEXT as vt}from"../langs/index.js";import{OUTPUT_DIR as Ao,FilterImg as Ho,FormatExt as Jo,GetExt as Ko,ShowTitle as io}from"../utils/index.js";function zt(){return x(this,arguments,void 0,(function*(t="",o){const n=ue(S(t)),e=Ko(t);if(ko(n)&&"webp"===e)return vt.result2(t,"webp动态图像无法标记");try{const{blend:n,color:e,label:r,left:i="",position:s,size:a,top:c=""}=o,l=qo(Ao.mark,t.replace(_(t),"")),f=S(qo(Ao.mark,Jo(t))),m=Object.assign({blend:n,input:Gt(r,+a,e)},"none"===s?{left:+i,top:+c}:{gravity:s});return ns(l),yield kt(t).composite([m]).toFile(f),vt.result1(t,r)}catch(o){return vt.result2(t,o.message)}}))}function Gt(t="",o=12,n=""){const e=Pt.loadSync().getSVG(t,{anchor:"top",attributes:{fill:n},fontSize:o>=12?o:12});return Buffer.from(e)}export default function Co(){return x(this,void 0,void 0,(function*(){io("mark");const t=yield ar(),o=no(vt.doing).start();eo(Ao.mark),ns(Ao.mark);const{count:n,imgs:e}=Ho("jpg,png,webp,JPG,PNG,WEBP"),r=e.map((o=>x(this,void 0,void 0,(function*(){return yield zt(o,t)})))),i=yield Promise.all(r);yield to(2e3),o.stop(),console.log(vt.stats(n)),i.length<=100&&i.forEach((t=>console.log(t))),console.log(vt.done),s(1)}))}