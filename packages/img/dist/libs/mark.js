var g=this&&this.__awaiter||function(t,o,e,r){return new(e||(e=Promise))((function(n,i){function s(t){try{l(r.next(t))}catch(t){i(t)}}function a(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){var o;t.done?n(t.value):(o=t.value,o instanceof e?o:new e((function(t){t(o)}))).then(s,a)}l((r=r.apply(t,o||[])).next())}))};import{readFileSync as ae}from"fs";import{basename as w,join as ei}from"path";import{exit as o}from"process";import{AbsPath as $,CreateDir as rs,RemoveDir as eo,WaitFor as no}from"@yangzw/bruce-us/dist/node.js";import co from"is-animated";import oo from"ora";import Et from"sharp";import Ft from"text-to-svg";import{MarkAnswer as ar}from"../helpers/index.js";import{MARK_TEXT as ea}from"../langs/index.js";import{OUTPUT_DIR as mi,FilterImg as ci,FormatExt as pi,GetExt as ui,ShowTitle as so}from"../utils/index.js";function St(t="",o){return g(this,void 0,void 0,(function*(){const e=ae($(t)),r=ui(t);if(co(e)&&"webp"===r)return ea.result2(t,"webp动态图像无法标记");try{const{blend:e,color:r,label:n,left:i="",position:s,size:a,top:l=""}=o,m=ei(mi.mark,t.replace(w(t),"")),c=$(ei(mi.mark,pi(t))),f=Object.assign({blend:e,input:Tt(n,+a,r)},"none"===s?{left:+i,top:+l}:{gravity:s});return rs(m),yield Et(t).composite([f]).toFile(c),ea.result1(t,n)}catch(o){return ea.result2(t,o.message)}}))}function Tt(t="",o=12,e=""){const r=Ft.loadSync().getSVG(t,{anchor:"top",attributes:{fill:e},fontSize:o>=12?o:12});return Buffer.from(r)}export default function uo(){return g(this,void 0,void 0,(function*(){so("mark");const t=yield ar(),e=oo(ea.doing).start();eo(mi.mark),rs(mi.mark);const{count:r,imgs:n}=ci("jpg,png,webp,JPG,PNG,WEBP"),i=n.map((o=>g(this,void 0,void 0,(function*(){return yield St(o,t)})))),s=yield Promise.all(i);yield no(2e3),e.stop(),console.log(ea.stats(r)),s.length<=100&&s.forEach((t=>console.log(t))),console.log(ea.done),o(1)}))}