var g=this&&this.__awaiter||function(t,e,o,r){return new(o||(o=Promise))((function(a,n){function i(t){try{l(r.next(t))}catch(t){n(t)}}function s(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?a(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(i,s)}l((r=r.apply(t,e||[])).next())}))};import{readFileSync as ae}from"fs";import{basename as w,join as ei}from"path";import{exit as o}from"process";import{AbsPath as $,CreateDir as rs,RemoveDir as eo,WaitFor as no}from"@yangzw/bruce-us/dist/node.js";import co from"is-animated";import oo from"ora";import Et from"sharp";import{TRANSFORM_TEXT as ir}from"../langs/index.js";import{OUTPUT_DIR as mi,FilterImg as ci,FormatExt as pi,GetExt as ui,ShowTitle as so}from"../utils/index.js";function At(t){return[{key:"blur",val:t.blur},{key:"extract",val:t.extract},{key:"flip",val:t.flip},{key:"flop",val:t.flop},{key:"grayscale",val:t.grayscale},{key:"negate",val:t.negate},{key:"normalise",val:t.normalise},{key:"resize",val:t.resize},{key:"rotate",val:t.rotate},{key:"sharpen",val:t.sharpen},{key:"toFormat",val:t.toFormat}].filter((t=>!!t.val))}function Rt(t="",e=[]){var o;return g(this,void 0,void 0,(function*(){const r=ae($(t)),a=ui(t);if(co(r)&&"webp"===a)return ir.result2(t,"webp动态图像无法变换");try{const r=ei(mi.transform,t.replace(w(t),"")),a=$(ei(mi.transform,pi(t))),n=e.reduce(((t,e)=>Array.isArray(e.val)?t[e.key](...e.val):!0===e.val?t[e.key]():t[e.key](e.val)),Et(t).withMetadata()),{val:i}=null!==(o=e.find((t=>"toFormat"===t.key)))&&void 0!==o?o:{};let s=null;if(rs(r),i&&"string"==typeof i){const e=w(t).split(".");e.pop();const o=e.concat(i).join("."),r=a.replace(w(t),o);s=yield n.toFile(r)}else s=yield n.toFile(a);return ir.result1(t,s)}catch(e){return ir.result2(t,e.message)}}))}export default function To(t){return g(this,void 0,void 0,(function*(){so("transform");const e=At(t);e.length||(console.log(ir.empty),o(1));const r=oo(ir.doing).start();eo(mi.transform),rs(mi.transform);const{count:a,imgs:n}=ci("jpg,png,webp,JPG,PNG,WEBP"),i=n.map((t=>g(this,void 0,void 0,(function*(){return yield Rt(t,e)})))),s=yield Promise.all(i);yield no(2e3),r.stop(),console.log(ir.stats(a)),s.length<=100&&s.forEach((t=>console.log(t))),console.log(ir.done),o(1)}))}