var g=this&&this.__awaiter||function(t,e,o,r){return new(o||(o=Promise))((function(a,n){function i(t){try{l(r.next(t))}catch(t){n(t)}}function s(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?a(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(i,s)}l((r=r.apply(t,e||[])).next())}))};import{readFileSync as le}from"fs";import{basename as w,join as We}from"path";import{exit as o}from"process";import{AbsPath as $,CreateDir as ns,RemoveDir as ze,WaitFor as Fe}from"@yangzw/bruce-us/dist/node.js";import Ge from"is-animated";import Ae from"ora";import Gt from"sharp";import{TRANSFORM_TEXT as Ve}from"../langs/index.js";import{OUTPUT_DIR as si,FilterImg as ai,FormatExt as mi,GetExt as ci,ShowTitle as Je}from"../utils/index.js";function Ut(t){return[{key:"blur",val:t.blur},{key:"extract",val:t.extract},{key:"flip",val:t.flip},{key:"flop",val:t.flop},{key:"grayscale",val:t.grayscale},{key:"negate",val:t.negate},{key:"normalise",val:t.normalise},{key:"resize",val:t.resize},{key:"rotate",val:t.rotate},{key:"sharpen",val:t.sharpen},{key:"toFormat",val:t.toFormat}].filter((t=>!!t.val))}function Wt(t="",e=[]){var o;return g(this,void 0,void 0,(function*(){const r=le($(t)),a=ci(t);if(Ge(r)&&"webp"===a)return Ve.result2(t,"webp动态图像无法变换");try{const r=We(si.transform,t.replace(w(t),"")),a=$(We(si.transform,mi(t))),n=e.reduce(((t,e)=>Array.isArray(e.val)?t[e.key](...e.val):!0===e.val?t[e.key]():t[e.key](e.val)),Gt(t).withMetadata()),{val:i}=null!==(o=e.find((t=>"toFormat"===t.key)))&&void 0!==o?o:{};let s=null;if(ns(r),i&&"string"==typeof i){const e=w(t).split(".");e.pop();const o=e.concat(i).join("."),r=a.replace(w(t),o);s=yield n.toFile(r)}else s=yield n.toFile(a);return Ve.result1(t,s)}catch(e){return Ve.result2(t,e.message)}}))}export default function lo(t){return g(this,void 0,void 0,(function*(){Je("transform");const e=Ut(t);e.length||(console.log(Ve.empty),o(1));const r=Ae(Ve.doing).start();ze(si.transform),ns(si.transform);const{count:a,imgs:n}=ai("jpg,png,webp,JPG,PNG,WEBP"),i=n.map((t=>g(this,void 0,void 0,(function*(){return yield Wt(t,e)})))),s=yield Promise.all(i);yield Fe(2e3),r.stop(),console.log(Ve.stats(a)),s.length<=100&&s.forEach((t=>console.log(t))),console.log(Ve.done),o(1)}))}