var x=this&&this.__awaiter||function(t,e,o,r){return new(o||(o=Promise))((function(n,a){function i(t){try{s(r.next(t))}catch(t){a(t)}}function l(t){try{s(r.throw(t))}catch(t){a(t)}}function s(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(i,l)}s((r=r.apply(t,e||[])).next())}))};import{readFileSync as ue}from"node:fs";import{basename as _,join as qo}from"node:path";import{exit as s}from"node:process";import{AbsPath as S,CreateDir as ns,RemoveDir as eo,WaitFor as to}from"@yangzw/bruce-us/dist/node.js";import ko from"is-animated";import no from"ora";import kt from"sharp";import{TRANSFORM_TEXT as t$}from"../langs/index.js";import{OUTPUT_DIR as Ao,FilterImg as Ho,FormatExt as Jo,GetExt as Ko,ShowTitle as io}from"../utils/index.js";function Ft(t){return[{key:"blur",val:t.blur},{key:"extract",val:t.extract},{key:"flip",val:t.flip},{key:"flop",val:t.flop},{key:"grayscale",val:t.grayscale},{key:"negate",val:t.negate},{key:"normalise",val:t.normalise},{key:"resize",val:t.resize},{key:"rotate",val:t.rotate},{key:"sharpen",val:t.sharpen},{key:"toFormat",val:t.toFormat}].filter((t=>!!t.val))}function At(){return x(this,arguments,void 0,(function*(t="",e=[]){var o;const r=ue(S(t)),n=Ko(t);if(ko(r)&&"webp"===n)return t$.result2(t,"webp动态图像无法变换");try{const r=qo(Ao.transform,t.replace(_(t),"")),n=S(qo(Ao.transform,Jo(t))),a=e.reduce(((t,e)=>Array.isArray(e.val)?t[e.key](...e.val):!0===e.val?t[e.key]():t[e.key](e.val)),kt(t).withMetadata()),{val:i}=null!==(o=e.find((t=>"toFormat"===t.key)))&&void 0!==o?o:{};let l=null;if(ns(r),i&&"string"==typeof i){const e=_(t).split(".");e.pop();const o=e.concat(i).join("."),r=n.replace(_(t),o);l=yield a.toFile(r)}else l=yield a.toFile(n);return t$.result1(t,l)}catch(e){return t$.result2(t,e.message)}}))}export default function Ro(t){return x(this,void 0,void 0,(function*(){io("transform");const e=Ft(t);e.length||(console.log(t$.empty),s(1));const o=no(t$.doing).start();eo(Ao.transform),ns(Ao.transform);const{count:r,imgs:n}=Ho("jpg,png,webp,JPG,PNG,WEBP"),a=n.map((t=>x(this,void 0,void 0,(function*(){return yield At(t,e)})))),i=yield Promise.all(a);yield to(2e3),o.stop(),console.log(t$.stats(r)),i.length<=100&&i.forEach((t=>console.log(t))),console.log(t$.done),s(1)}))}