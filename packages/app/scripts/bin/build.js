import{exit as Ho}from"process";import{ReadJson as l,RemoveDir as _e}from"@yangzw/bruce-us/dist/node.js";import Ue from"ora";import N from"webpack";import Ve from"webpack-dev-server";import{BrucercConfig as c}from"../../configs/config/index.js";import{DevWebpack as le,ProdWebpack as oo}from"../../configs/webpack/index.js";import{BUILD_TEXT as ro}from"../../constants/i18n/index.js";import{AbsPath as w,BuildApp as ot,IsPath as X,JudgeFile as i,ShowMsg as it,ShowTitle as mt,UploadFiles as et,WatchFiles as gt}from"../../constants/util/index.js";import{BuildAnswer as zo}from"../../helpers/answer/index.js";export default async function We(){mt("build");const e=i("","configFile"),o=i("src");if(!e)return it("red",ro.judgeBrucerc),Ho(1);if(!o)return it("red",ro.judgeIndexes),Ho(1);if(!X("package.json"))return it("red",ro.judgePackage),Ho(1);if(!X("node_modules"))return it("red",ro.judgeModules),Ho(1);const t={...await zo(),...await c()};if(t.useTs&&!X("tsconfig.json"))return it("red",ro.judgeTsconfig),Ho(1);if("dev"===t.mode){const e=Ue(ro.doing1).start(),o=le(t),r=N(o),s=new Ve({allowedHosts:"all",headers:{"Access-Control-Allow-Origin":"*"},historyApiFallback:!0,host:t?.proxyHost||"local-ip",hot:!0,open:!!t.useOpener&&(!t.openPages?.length||t.openPages.filter(Boolean)),port:t.port,proxy:t.proxy,server:t.useHttps?"https":"http",static:{directory:w("dist")}},r);e.stop(),await s.start(),gt((e=>{console.log(ro.watch(e)),Ho(1)}))}else{const{name:e,version:o}=l("package.json"),r=Ue(ro.doing1).start(),s=oo(t);await _e(`dist/${t.mode}`),r.stop();const[n,i]=await ot(s),d=s.output.path;if(n||!i)it("red",ro.undone1({mode:t.mode,name:e,ver:o})),t?.buildErrorCb?.({err:n,mode:t.mode,path:d}),Ho(1);else{if(it("green",ro.done1({mode:t.mode,name:e,ver:o})),t?.buildSuccessCb?.({mode:t.mode,path:d}),t.uploadOpts){const e=Ue(ro.doing2).start(),o=await et({mode:t.mode,opts:t.uploadOpts,path:d});e.stop(),o?it("green",ro.done2):it("red",ro.undone2)}Ho(1)}}}