import{exit as Co}from"process";import{ReadJson as l,RemoveDir as _e}from"@yangzw/bruce-us/dist/node.js";import Oo from"ora";import N from"webpack";import Ue from"webpack-dev-server";import{BrucercConfig as c}from"../../configs/config/index.js";import{DevWebpack as le,ProdWebpack as oo}from"../../configs/webpack/index.js";import{BUILD_TEXT as ro}from"../../constants/i18n/index.js";import{AbsPath as w,BuildApp as tt,IsPath as X,JudgeFile as i,ShowMsg as rt,ShowTitle as it,UploadFiles as mt,WatchFiles as et}from"../../constants/util/index.js";import{BuildAnswer as zo}from"../../helpers/answer/index.js";export default async function Ve(){it("build");const e=i("","configFile"),o=i("src");if(!e)return rt("red",ro.judgeBrucerc),Co(1);if(!o)return rt("red",ro.judgeIndexes),Co(1);if(!X("package.json"))return rt("red",ro.judgePackage),Co(1);if(!X("node_modules"))return rt("red",ro.judgeModules),Co(1);const t={...await zo(),...await c()};if(t.useTs&&!X("tsconfig.json"))return rt("red",ro.judgeTsconfig),Co(1);if("dev"===t.mode){const e=Oo(ro.doing1).start(),o=le(t),r=N(o),s=new Ue({allowedHosts:"all",headers:{"Access-Control-Allow-Origin":"*"},historyApiFallback:!0,host:t?.proxyHost||"local-ip",hot:!0,open:!!t.useOpener&&(!t.openPages?.length||t.openPages.filter(Boolean)),port:t.port,proxy:t.proxy,server:t.useHttps?"https":"http",static:{directory:w("dist")}},r);e.stop(),await s.start(),et((e=>{console.log(ro.watch(e)),Co(1)}))}else{const{name:e,version:o}=l("package.json"),r=Oo(ro.doing1).start(),s=oo(t);await _e(`dist/${t.mode}`),r.stop();const[n,i]=await tt(s),d=s.output.path;if(n||!i)rt("red",ro.undone1({mode:t.mode,name:e,ver:o})),t?.buildErrorCb?.({err:n,mode:t.mode,path:d}),Co(1);else{if(rt("green",ro.done1({mode:t.mode,name:e,ver:o})),t?.buildSuccessCb?.({mode:t.mode,path:d}),t.uploadOpts){const e=Oo(ro.doing2).start(),o=await mt({mode:t.mode,opts:t.uploadOpts,path:d});e.stop(),o?rt("green",ro.done2):rt("red",ro.undone2)}Co(1)}}}