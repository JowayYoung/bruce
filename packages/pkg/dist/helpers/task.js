var g=this&&this.__awaiter||function(r,t,e,o){return new(e||(e=Promise))((function(n,i){function s(r){try{u(o.next(r))}catch(r){i(r)}}function a(r){try{u(o.throw(r))}catch(r){i(r)}}function u(r){var t;r.done?n(r.value):(t=r.value,t instanceof e?t:new e((function(r){r(t)}))).then(s,a)}u((o=o.apply(r,t||[])).next())}))};import{CheckPath as _e,WaitFor as no}from"@yangzw/bruce-us/dist/node.js";import{execa as ur}from"execa";import{Listr as tn}from"listr2";import p from"semver";import{PUBLISH_TEXT as pr}from"../langs/index.js";const{valid:dr}=p,rn={task(r,t){return g(this,void 0,void 0,(function*(){try{t.output="npm whoami";const{stdout:r}=yield ur("npm",["whoami"]);if(yield no(),!r)throw new Error(pr.errorAuth)}catch(r){throw new Error(pr.errorAuth)}}))},title:pr.taskAuth},cr={task(r,t){return g(this,void 0,void 0,(function*(){try{t.output="node -v";const{stdout:r}=yield ur("node",["-v"]);if(yield no(),!dr(r))throw new Error(pr.errorEnvNode)}catch(r){throw new Error(pr.errorEnvNode)}}))},title:pr.taskEnvNode},hr={task(r,t){return g(this,void 0,void 0,(function*(){try{t.output="npm -v";const{stdout:r}=yield ur("npm",["-v"]);if(yield no(),!dr(r))throw new Error(pr.errorEnvNpm)}catch(r){throw new Error(pr.errorEnvNpm)}}))},title:pr.taskEnvNpm},lr={task(r,t){return g(this,void 0,void 0,(function*(){try{t.output="npm config get registry";const{stdout:r}=yield ur("npm",["config","get","registry"]);if(yield no(),"https://registry.npmjs.org/"!==r)throw new Error(pr.errorEnvRegistry)}catch(r){throw new Error(pr.errorEnvRegistry)}}))},title:pr.taskEnvRegistry},on={task:()=>new tn([cr,hr,lr]),title:pr.taskEnv},vr={enabled:r=>!1===r.yarn,task(r,t){return g(this,void 0,void 0,(function*(){try{if(_e("node_modules"))return;t.output="npm i",yield ur("npm",["i"])}catch(r){throw new Error(pr.errorDepsNpm)}}))},title:pr.taskDepsNpm},yr={task(r,t){return g(this,void 0,void 0,(function*(){try{if(_e("node_modules"))return;t.output="pnpm",r.pnpm=!0,yield ur("pnpm",["i"])}catch(e){r.pnpm=!1,t.skip(pr.errorDepsPnpm)}}))},title:pr.taskDepsPnpm},wr={enabled:r=>!1===r.pnpm,task(r,t){return g(this,void 0,void 0,(function*(){try{if(_e("node_modules"))return;t.output="yarn",r.yarn=!0,yield ur("yarn")}catch(e){r.yarn=!1,t.skip(pr.errorDepsYarn)}}))},title:pr.taskDepsYarn},fr={task:()=>new tn([yr,wr,vr]),title:pr.taskDeps},en={task(r,t){return g(this,void 0,void 0,(function*(){try{t.output="npm publish",yield ur("npm",["publish"]),yield no()}catch(r){const{message:t}=r;if(t.includes("- Forbidden"))throw new Error(pr.errorPublish.noaccess);if(t.includes("- You do not have permission to publish"))throw new Error(pr.errorPublish.occupied);if(t.includes("- Package name too similar to existing packages"))throw new Error(pr.errorPublish.similar);throw t.includes("- You cannot publish over the previously published versions")?new Error(pr.errorPublish.version):new Error(pr.errorPublish.disabled)}}))},title:pr.taskPublish};export{rn as CHECK_AUTH,fr as CHECK_DEPS,on as CHECK_ENV,en as CHECK_PUBLISH};