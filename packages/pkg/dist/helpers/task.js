var x=this&&this.__awaiter||function(r,t,o,e){return new(o||(o=Promise))((function(n,i){function s(r){try{a(e.next(r))}catch(r){i(r)}}function u(r){try{a(e.throw(r))}catch(r){i(r)}}function a(r){var t;r.done?n(r.value):(t=r.value,t instanceof o?t:new o((function(r){r(t)}))).then(s,u)}a((e=e.apply(r,t||[])).next())}))};import{CheckPath as Ke,WaitFor as to}from"@yangzw/bruce-us/dist/node.js";import{execa as tr}from"execa";import{Listr as wn}from"listr2";import a from"semver";import{PUBLISH_TEXT as ur}from"../langs/index.js";const{valid:pr}=a,xn={task(r,t){return x(this,void 0,void 0,(function*(){try{t.output="npm whoami";const{stdout:r}=yield tr("npm",["whoami"]);if(yield to(),!r)throw new Error(ur.errorAuth)}catch(r){throw new Error(ur.errorAuth)}}))},title:ur.taskAuth},dr={task(r,t){return x(this,void 0,void 0,(function*(){try{t.output="node -v";const{stdout:r}=yield tr("node",["-v"]);if(yield to(),!pr(r))throw new Error(ur.errorEnvNode)}catch(r){throw new Error(ur.errorEnvNode)}}))},title:ur.taskEnvNode},cr={task(r,t){return x(this,void 0,void 0,(function*(){try{t.output="npm -v";const{stdout:r}=yield tr("npm",["-v"]);if(yield to(),!pr(r))throw new Error(ur.errorEnvNpm)}catch(r){throw new Error(ur.errorEnvNpm)}}))},title:ur.taskEnvNpm},hr={task(r,t){return x(this,void 0,void 0,(function*(){try{t.output="npm config get registry";const{stdout:r}=yield tr("npm",["config","get","registry"]);if(yield to(),"https://registry.npmjs.org/"!==r)throw new Error(ur.errorEnvRegistry)}catch(r){throw new Error(ur.errorEnvRegistry)}}))},title:ur.taskEnvRegistry},bn={task:()=>new wn([dr,cr,hr]),title:ur.taskEnv},lr={enabled:r=>!1===r.yarn,task(r,t){return x(this,void 0,void 0,(function*(){try{if(Ke("node_modules"))return;t.output="npm i",yield tr("npm",["i"])}catch(r){throw new Error(ur.errorDepsNpm)}}))},title:ur.taskDepsNpm},vr={task(r,t){return x(this,void 0,void 0,(function*(){try{if(Ke("node_modules"))return;t.output="pnpm",r.pnpm=!0,yield tr("pnpm",["i"])}catch(o){r.pnpm=!1,t.skip(ur.errorDepsPnpm)}}))},title:ur.taskDepsPnpm},yr={enabled:r=>!1===r.pnpm,task(r,t){return x(this,void 0,void 0,(function*(){try{if(Ke("node_modules"))return;t.output="yarn",r.yarn=!0,yield tr("yarn")}catch(o){r.yarn=!1,t.skip(ur.errorDepsYarn)}}))},title:ur.taskDepsYarn},wr={task:()=>new wn([vr,yr,lr]),title:ur.taskDeps},kn={task(r,t){return x(this,void 0,void 0,(function*(){try{t.output="npm publish",yield tr("npm",["publish"]),yield to()}catch(r){const{message:t}=r;if(t.includes("- Forbidden"))throw new Error(ur.errorPublish.noaccess);if(t.includes("- You do not have permission to publish"))throw new Error(ur.errorPublish.occupied);if(t.includes("- Package name too similar to existing packages"))throw new Error(ur.errorPublish.similar);throw t.includes("- You cannot publish over the previously published versions")?new Error(ur.errorPublish.version):new Error(ur.errorPublish.disabled)}}))},title:ur.taskPublish};export{xn as CHECK_AUTH,wr as CHECK_DEPS,bn as CHECK_ENV,kn as CHECK_PUBLISH};